# Agents 시스템 아키텍처

## 1. 에이전트 아키텍처

에이전트 시스템은 여러 조정된 에이전트 역할을 가진 **스킬 기반 디스패치 패턴**으로 구축되었습니다:

### 핵심 에이전트 유형
- **Implementer Subagent** - TDD 규율로 특정 작업 실행
- **Spec Reviewer Subagent** - 명세 준수 검증 (많지도 적지도 않게)
- **Code Quality Reviewer Subagent** - 코드가 잘 구축되었는지 확인 (깨끗함, 테스트됨, 유지 가능)
- **Code Reviewer Agent** - 원래 계획 및 코딩 표준에 대한 작업 리뷰
- **Primary Agent** - 워크플로우 조율 및 서브에이전트 조정

### 스킬 기반 발견 시스템
`/lib/skills-core.js`에 위치하며, 시스템은:
- 이름과 설명이 있는 스킬 파일에서 YAML frontmatter 추출
- 스킬 디렉토리의 모든 SKILL.md 파일을 재귀적으로 찾음 (최대 3레벨 깊이)
- 네임스페이싱 지원: `superpowers:skill-name` 또는 개인 스킬
- 개인 스킬이 superpowers 스킬을 오버라이드 (섀도잉 패턴)
- git 작업을 사용하여 업데이트 확인 및 상태 검증

---

## 2. SUBAGENT-DRIVEN-DEVELOPMENT 아키텍처

계획 구현을 위한 주요 실행 패턴:

```
작업당 사이클:
├── 1. Implementer Subagent 디스패치
│   ├── 수신: 전체 작업 텍스트, 장면 설정 컨텍스트
│   ├── 명확화 질문 가능 (작업 전 AND 중)
│   └── 제공: 구현, 테스트, 커밋, 자가 리뷰
├── 2. 2단계 리뷰 (순차적)
│   ├── 1단계: 명세 준수 리뷰
│   │   ├── 구현이 명세와 정확히 일치하는지 검증
│   │   ├── 누락된 요구사항 확인
│   │   ├── 과도한 구축 확인 (YAGNI 위반)
│   │   └── 이슈 → Implementer 수정 → 재검토
│   └── 2단계: 코드 품질 리뷰
│       ├── 명세 준수 통과 후에만 실행
│       ├── 깨끗한 코드, 테스팅, 유지 가능성 확인
│       └── 이슈 → Implementer 수정 → 재검토
└── 3. TodoWrite에서 작업을 완료로 표시

다작업 조율:
├── 계획 파일에서 모든 작업을 미리 추출
├── 모든 작업으로 TodoWrite 생성
├── 작업을 순차적으로 반복
├── 각 작업은 작업당 사이클 실행
├── 모든 작업 후: 최종 코드 검토자 디스패치
└── superpowers:finishing-a-development-branch 사용
```

**핵심 디자인 원칙: 작업당 새 서브에이전트 + 2단계 리뷰 (명세 후 품질) = 높은 품질, 빠른 반복**

---

## 3. SUBAGENT-DRIVEN-DEVELOPMENT 작동 방식

### 프로세스 흐름

#### 1. 사전 준비
- 컨트롤러가 계획 파일을 한 번 읽음
- 모든 작업 설명을 미리 추출
- 전체 작업 목록으로 TodoWrite 생성
- 서브에이전트에게 계획 파일을 읽게 하지 않음

#### 2. 작업당 구현
- 다음과 함께 implementer subagent 디스패치:
  - 작업의 전체 텍스트 (파일 참조 아님)
  - 장면 설정 컨텍스트 (아키텍처적으로 어디에 맞는지)
  - 의존성 및 가정
- 서브에이전트가 미리 명확화 질문 가능
- 서브에이전트가 TDD를 사용하여 구현
- 서브에이전트가 자가 리뷰 수행 (자신의 이슈 포착)
- 서브에이전트가 작업 커밋

#### 3. 2단계 리뷰 (명세 → 품질)
- **Spec Reviewer:** "정확히 요청된 것을 구축했나요?"
  - 실제 코드를 읽어 검증 (보고서 신뢰 안 함)
  - 보고: 누락된 요구사항, 추가/불필요한 작업, 오해
  - 이슈는 품질 리뷰로 진행하기 전에 해결되어야 함
- **Code Quality Reviewer:** "잘 구축되었나요?"
  - 깨끗한 코드, 테스트 커버리지, 유지 가능성 확인
  - 명세 준수 통과 후에만 실행 (중요한 순서)
  - code-reviewer.md 템플릿에 대해 리뷰

#### 4. 완료될 때까지 반복
- 검토자가 이슈를 발견하면 → Implementer가 수정 → 다시 검토
- 열린 이슈가 있으면 다음 단계로 진행하지 않음
- 재검토는 필수 (건너뛰지 않음)

### 효율성 향상
- 컨트롤러가 전체 작업 텍스트 제공 (서브에이전트 오버헤드로 파일 읽기 없음)
- 작업 시작 전 질문 제기 (후가 아님)
- 자가 리뷰가 이슈를 조기에 포착 (리뷰가 발견하는 것보다 저렴)
- 2단계 리뷰가 과소 구축과 과도 구축 모두 방지
- 명세 준수 우선으로 코드 최적화 전에 요구사항이 충족됨을 보장

---

## 4. 에이전트 조정 및 커뮤니케이션

### 조정 패턴

#### 1. 순차적 작업 디스패치
- 작업이 파이프라인을 통해 한 번에 하나씩 흐름
- 이전 작업이 완료되어야 다음이 시작
- 병렬 에이전트의 충돌 방지

#### 2. 컨텍스트 격리
- 각 서브에이전트가 새 컨텍스트를 받음 (이전 작업의 오염 없음)
- 전체 작업 텍스트를 미리 제공 (효율성 + 명확성)
- 장면 설정 컨텍스트가 작업이 시스템에 어떻게 맞는지 설명

#### 3. 명시적 커뮤니케이션 프로토콜
- Spec reviewer 질문: "구현이 명세와 일치하나요?" (예/아니오 + 세부 사항)
- Quality reviewer 평가: "강점? 이슈? 승인?"
- Implementer 보고: 무엇을 구축했는지, 테스트 결과, 변경된 파일, 자가 리뷰 발견
- 이슈 분류: Critical (반드시 수정), Important (수정해야 함), Minor (있으면 좋음)

#### 4. 병렬 에이전트 디스패치
- 대체 스킬: `dispatching-parallel-agents`
- 3개 이상의 독립적인 실패/도메인이 있을 때 사용
- 각 에이전트가 집중된 범위 + 제약 조건을 받음
- 에이전트가 간섭 없이 동시에 작업
- 요구사항:
  - 독립적인 문제 도메인
  - 조사 간 공유 상태 없음
  - 에이전트당 명확한 성공 기준

#### 5. 작업 공간 격리
- git worktrees 사용 (브랜치 전환 아님)
- 격리된 개발 작업 공간 생성
- 여러 에이전트가 동시에 작업할 수 있게 함
- 스마트 디렉토리 선택 (`.worktrees/` 선호)
- 안전 검증 (디렉토리가 gitignore되었는지 확인)

---

## 5. 사용 가능한 에이전트 유형

### agents/ 폴더에서
- `code-reviewer.md` - 주요 프로젝트 단계를 위한 시니어 코드 검토자

### 전용 서브에이전트 프롬프트가 있는 skills/에서

| 에이전트 유형 | 스킬 | 목적 | 사용 시점 |
|-------------|------|------|-----------|
| Implementer | subagent-driven-development | TDD로 특정 작업 실행 | 계획 실행에서 작업당 |
| Spec Reviewer | subagent-driven-development | 명세 준수 검증 | implementer 완료 후 |
| Code Quality Reviewer | subagent-driven-development | 코드 품질 리뷰 | 명세 준수 통과 후 |
| Parallel Agents | dispatching-parallel-agents | 독립적인 도메인 조사 | 여러 독립적인 실패 |
| Code Reviewer | requesting-code-review | 일반 코드 리뷰 | merge 전, 주요 피처 |

### 에이전트를 조율하는 스킬
- `brainstorming` - 아이디어를 디자인으로 개선
- `writing-plans` - 디자인을 작은 단위 작업으로 분해
- `subagent-driven-development` - 서브에이전트 디스패치로 계획 실행
- `executing-plans` - 체크포인트가 있는 배치 실행
- `test-driven-development` - TDD 규율 보장
- `using-git-worktrees` - 격리된 작업 공간 설정
- `finishing-a-development-branch` - 개발 완료

---

## 6. 핵심 디자인 원칙

### 1. 2단계 리뷰가 중요
- 코드 품질 전에 명세 준수를 반드시 실행
- 두 단계 모두 건너뛰지 않음
- 이슈 발견 = implementer 수정 = 다시 검토

### 2. 작업당 새 컨텍스트
- 각 서브에이전트가 새로 시작 (컨텍스트 오염 없음)
- 컨트롤러가 필요한 모든 정보를 미리 제공
- 피로, 혼란, 결정 드리프트 방지

### 3. 작업 전 질문
- 서브에이전트가 구현 전 명확화 가능
- 전체 작업이 잘못 구축되는 것을 방지
- 사후 수정보다 미리 명확화하는 것이 나음

### 4. 자가 리뷰 + 공식 리뷰
- Implementer가 인계 전 자가 리뷰
- 이슈를 조기에 포착 (리뷰 반복 감소)
- 공식 리뷰가 완전성 및 품질 검증

### 5. 과도한 구축 금지 (YAGNI)
- Spec reviewer가 추가 기능을 명시적으로 확인
- 금도금 및 범위 확장 방지
- 요구사항이 경계를 정의

### 6. TDD 규율
- 모든 서브에이전트가 RED-GREEN-REFACTOR 따름
- 테스트가 구현 전 동작을 정의
- 테스트 전에 작성된 모든 코드 삭제

---

## 7. 레드 플래그 및 안전 확인

### 중요한 위반 (절대 하지 말 것)
- 명시적인 사용자 동의 없이 main/master에서 코드 시작
- 명세 준수 또는 코드 품질 리뷰 건너뛰기
- 수정되지 않은 이슈로 진행
- 여러 구현 서브에이전트를 병렬로 디스패치 (충돌)
- 서브에이전트에게 계획 파일 읽게 하기 (대신 전체 텍스트 제공)
- 장면 설정 컨텍스트 건너뛰기 (서브에이전트가 아키텍처 이해 필요)
- 서브에이전트 질문 무시 (진행 전 답변)
- 명세 준수에서 "충분히 가까움" 수용
- 리뷰 루프 건너뛰기 (검토자가 이슈 발견 = implementer 수정 = 다시 검토)
- 명세 준수 통과 전에 품질 리뷰 시작
- 열린 리뷰 이슈로 다음 작업으로 이동

### 순서가 중요
- 명세 준수 항상 코드 품질 전
- 이 순서를 절대 바꾸지 않음
- 다음 작업 전에 둘 다 통과해야 함

---

## 요약

이 디자인은 에이전트가 명확한 인계 지점, 품질 게이트, 피드백 루프로 체계적으로 작업하여 대규모로 고품질 구현을 생성하는 견고한 시스템을 만듭니다.
